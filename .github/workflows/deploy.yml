name: CI/CD Mini Toolkit DevOps

on:
  push:
    branches: [ main ]

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: 🧩 Checkout código
      uses: actions/checkout@v4

    - name: 🐚 Verificar scripts Bash (ShellCheck)
      uses: ludeeus/action-shellcheck@master

    - name: 🐳 Build imagem Docker da aplicação
      run: |
        cd app
        docker build -t mini-toolkit-api:latest .

    - name: 🔐 Configurar acesso SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.AWS_SSH_KEY }}

    - name: 📦 Copiar toolkit e app para EC2
      run: |
        rsync -avz -e "ssh -o StrictHostKeyChecking=no" ./ ubuntu@${{ secrets.AWS_HOST }}:/home/ubuntu/mini-toolkit-devops

    - name: 🚀 Fazer deploy na EC2
      run: |
        ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.AWS_HOST }} << 'EOF'
          cd ~/mini-toolkit-devops/app
          docker stop mini-toolkit-api || true
          docker rm mini-toolkit-api || true
          docker build -t mini-toolkit-api:latest .
          docker run -d \
            --name mini-toolkit-api \
            --network web \
            -l "traefik.enable=true" \
            -l "traefik.http.routers.mini-toolkit.rule=Host(`toolkit-api.sparkflux.com.br`)" \
            -l "traefik.http.routers.mini-toolkit.entrypoints=websecure" \
            -l "traefik.http.routers.mini-toolkit.tls.certresolver=letsencrypt" \
            -l "traefik.http.services.mini-toolkit.loadbalancer.server.port=3000" \
            mini-toolkit-api:latest
          echo "✅ Deploy concluído com sucesso!"
        EOF
